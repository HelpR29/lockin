<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - LockIn</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Orbitron:wght@400;500;600;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="bg-animation">
        <div class="grid-overlay"></div>
        <canvas id="particle-canvas"></canvas>
    </div>
    
    <div class="container">
        <header class="header">
            <div class="logo" onclick="window.location.href='index.html'" style="cursor: pointer;">
                <div class="logo-icon-wrapper">
                    <svg class="logo-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="40" stroke="currentColor" stroke-width="6"/>
                        <rect x="32" y="42" width="36" height="36" rx="4" fill="currentColor"/>
                        <path d="M38 42V30C38 23.3726 43.3726 18 50 18C56.6274 18 62 23.3726 62 30V42" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
                        <circle cx="50" cy="58" r="4" fill="#2C2C2E"/>
                        <rect x="48" y="58" width="4" height="10" rx="2" fill="#2C2C2E"/>
                    </svg>
                </div>
                <span class="logo-text">LockIn</span>
            </div>
        </header>

        <section class="auth-section" style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
            <div class="auth-container" style="max-width: 500px; margin: 0 auto;">
                <div class="auth-card" style="text-align: center;">
                    <h1 class="auth-title">Reset Your Password</h1>
                    <p class="auth-subtitle">Enter your new password below.</p>

                    <form id="resetPasswordForm" class="auth-form" style="text-align: left;">
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" placeholder="Enter new password" required minlength="6">
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm new password" required minlength="6">
                        </div>

                        <button type="submit" class="cta-primary-large" id="resetBtn">
                            <span id="resetBtnText">Reset Password</span>
                        </button>
                    </form>

                    <div class="auth-footer">
                        <p>Remember your password? <a href="login.html">Log In</a></p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
    <script src="script.js"></script>
    <script>
        // Check for session on page load
        async function checkResetSession() {
            try {
                // Check if user has a valid session from the reset link
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Session error:', error);
                }
                
                if (!session) {
                    // No session found - check if there's a recovery token in the URL
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    const accessToken = hashParams.get('access_token');
                    const type = hashParams.get('type');
                    
                    if (type !== 'recovery' || !accessToken) {
                        alert('Invalid or expired password reset link. Please request a new one.');
                        window.location.href = 'login.html';
                        return false;
                    }
                    
                    // Set the session using the recovery token
                    const { error: setError } = await supabase.auth.setSession({
                        access_token: accessToken,
                        refresh_token: hashParams.get('refresh_token') || ''
                    });
                    
                    if (setError) {
                        console.error('Error setting session:', setError);
                        alert('Invalid or expired reset link. Please request a new password reset.');
                        window.location.href = 'login.html';
                        return false;
                    }
                }
                
                return true;
            } catch (err) {
                console.error('Error checking session:', err);
                alert('An error occurred. Please try again.');
                window.location.href = 'login.html';
                return false;
            }
        }
        
        // Initialize the page
        (async () => {
            const sessionValid = await checkResetSession();
            if (!sessionValid) return;
            
            // Setup form submission
            document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const btn = document.getElementById('resetBtn');
                const btnText = document.getElementById('resetBtnText');
                
                // Validate passwords match
                if (newPassword !== confirmPassword) {
                    alert('Passwords do not match!');
                    return;
                }
                
                // Validate password length
                if (newPassword.length < 6) {
                    alert('Password must be at least 6 characters long.');
                    return;
                }
                
                // Disable button
                btn.disabled = true;
                btnText.textContent = 'Resetting...';
                
                try {
                    const { data, error } = await supabase.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (error) throw error;
                    
                    alert('Password updated successfully! You can now log in with your new password.');
                    
                    // Sign out to clear the recovery session
                    await supabase.auth.signOut();
                    
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error resetting password:', error);
                    alert(error.message || 'Error resetting password. Please try again.');
                    btn.disabled = false;
                    btnText.textContent = 'Reset Password';
                }
            });
        })();
    </script>
</body>
</html>
